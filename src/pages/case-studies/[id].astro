---
import Layout from "@/layouts/Layout.astro";
import CTABottom from "@/components/CTA.astro";
import { createSEO } from "@/utils/seo";
import { getCollection, render } from "astro:content";
import type { RenderResult } from "astro:content";
import ProjectCarousel from "@/components/ProjectCarousel.tsx";
import { getCaseStudySchema, getBreadcrumbSchema } from "@/lib/schemas";
import { siteConfig } from "@/config/site";
export const prerender = true;

export async function getStaticPaths() {
  const caseStudies = await getCollection("caseStudies");
  return caseStudies.map((caseStudy) => ({
    params: { id: caseStudy.id },
    props: { caseStudy },
  }));
}

const { caseStudy } = Astro.props;
let rendered: RenderResult | null = null;

if (caseStudy) {
  rendered = await render(caseStudy);
} else {
  console.error("Case study not found");
}

const seo = createSEO({
  pageName: caseStudy.data.title,
  description: caseStudy.data.description,
  contentType: "case-study",
  pathname: `/case-studies/${caseStudy.id}`,
});

seo.structuredData = [
  getCaseStudySchema({
    title: caseStudy.data.title,
    description: caseStudy.data.description,
    problemStatement: caseStudy.data.problemStatement,
    solution: caseStudy.data.solution,
    techStack: caseStudy.data.techStack,
    pubDate: new Date(caseStudy.data.pubDate),
    url: `${siteConfig.url}/case-studies/${caseStudy.id}`,
  }),
  getBreadcrumbSchema([
    { name: "Home", url: siteConfig.url },
    { name: "Case Studies", url: `${siteConfig.url}/case-studies` },
    { name: caseStudy.data.title, url: `${siteConfig.url}/case-studies/${caseStudy.id}` },
  ])
];

// Define slide data for layaway solution
const layawaySlides = [
  {
    image: "https://images.unsplash.com/photo-1563013544-824ae1b704d3?ixlib=rb-4.0.3&auto=format&fit=crop&w=1200&h=600&q=80",
    alt: "Modern dashboard interface with analytics",
    title: "Customer Dashboard",
    description: "Secure passwordless login and payment management interface"
  },
  {
    image: "https://images.unsplash.com/photo-1556742502-ec7c0e9f34b1?ixlib=rb-4.0.3&auto=format&fit=crop&w=1200&h=600&q=80",
    alt: "Payment processing and financial technology",
    title: "Payment Integration",
    description: "Stripe + Plaid integration for ACH-based automated payments"
  },
  {
    image: "https://images.unsplash.com/photo-1460925895917-afdab827c52f?ixlib=rb-4.0.3&auto=format&fit=crop&w=1200&h=600&q=80",
    alt: "Admin dashboard with charts and analytics",
    title: "Admin Panel",
    description: "Merchant configuration and layaway plan management"
  },
  {
    image: "https://images.unsplash.com/photo-1551434678-e076c223a692?ixlib=rb-4.0.3&auto=format&fit=crop&w=1200&h=600&q=80",
    alt: "Mobile app interface showing payment plans",
    title: "Mobile Experience",
    description: "Responsive design for seamless mobile payments"
  },
  {
    image: "https://images.unsplash.com/photo-1554224155-6726b3ff858f?ixlib=rb-4.0.3&auto=format&fit=crop&w=1200&h=600&q=80",
    alt: "Security and encryption visualization",
    title: "Security Features",
    description: "Bank-level security with PCI compliance"
  }
];
---

<Layout seo={seo}>
  <div class="min-h-screen bg-background">
    <!-- Hero Section -->
    <section class="relative pt-24 md:pt-32 pb-16 md:pb-20 px-4 bg-gradient-to-br from-white via-primary-50/30 to-primary-100/50">
      <div class="absolute inset-0 bg-grid-pattern opacity-5"></div>
      <div class="max-w-7xl mx-auto relative">
        <div class="grid lg:grid-cols-2 gap-8 lg:gap-12 items-center">
          <!-- Content -->
          <div class="space-y-8">
            <div class="space-y-4">
              <div class="inline-flex items-center gap-3 bg-white/80 backdrop-blur-sm px-4 py-2 rounded-full shadow-sm">
                {caseStudy.data.logos?.client?.src ? (
                  <img 
                    src={caseStudy.data.logos.client.src} 
                    alt={caseStudy.data.logos.client.alt || caseStudy.data.client} 
                    class="h-6 w-auto"
                  />
                ) : null}
                <span class="text-sm font-medium text-gray-700">{caseStudy.data.client}</span>
                <span class="text-xs text-muted-foreground">Case Study</span>
              </div>
              <h1 class="text-3xl md:text-4xl lg:text-6xl font-bold text-gray-900 leading-tight">
                {caseStudy.data.title.split('–')[0].trim()}
                {caseStudy.data.title.includes('–') && (
                  <span class="block text-2xl md:text-3xl lg:text-4xl text-primary-600 mt-2">
                    {caseStudy.data.title.split('–')[1].trim()}
                  </span>
                )}
              </h1>
              <p class="text-lg md:text-xl text-muted-foreground leading-relaxed max-w-xl">
                {caseStudy.data.description}
              </p>
            </div>
            
            <!-- Quick Stats -->
            <div class="flex flex-wrap gap-4 md:gap-6">
              <div class="bg-white/60 backdrop-blur-sm px-3 md:px-4 py-2 md:py-3 rounded-lg border border-gray-200/50">
                <div class="text-xs md:text-sm text-muted-foreground">Timeline</div>
                <div class="text-sm md:text-base font-semibold text-gray-900">{caseStudy.data.timeframe}</div>
              </div>
              <div class="bg-white/60 backdrop-blur-sm px-3 md:px-4 py-2 md:py-3 rounded-lg border border-gray-200/50">
                <div class="text-xs md:text-sm text-muted-foreground">Technologies</div>
                <div class="text-sm md:text-base font-semibold text-gray-900">{caseStudy.data.techStack.length} Stack</div>
              </div>
            </div>
          </div>
          
          <!-- Visual Element -->
          <div class="relative mt-8 lg:mt-0">
            <div class="bg-gradient-to-br from-primary-500 to-primary-700 rounded-2xl p-6 md:p-8 shadow-2xl">
              <div class="bg-white rounded-xl p-4 md:p-6 space-y-4">
                <div class="flex items-center justify-between">
                  <div class="text-sm font-medium text-muted-foreground">Project Overview</div>
                  <div class="w-3 h-3 bg-green-400 rounded-full"></div>
                </div>
                <div class="space-y-3">
                  <div class="h-4 bg-gray-200 rounded animate-pulse"></div>
                  <div class="h-4 bg-gray-200 rounded w-3/4 animate-pulse"></div>
                  <div class="h-4 bg-gray-200 rounded w-1/2 animate-pulse"></div>
                </div>
                <div class="flex flex-wrap gap-2 pt-2">
                  {caseStudy.data.techStack.slice(0, 4).map((tech: string) => (
                    <div class="px-2 py-1 bg-primary-50 text-primary-700 text-xs rounded font-medium">
                      {tech}
                    </div>
                  ))}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Project Details Section -->
    <section class="py-12 md:py-16 px-4 bg-primary-50">
      <div class="max-w-6xl mx-auto">
        <div class="flex justify-center">
          <div class="bg-white p-6 md:p-8 rounded-xl shadow-lg text-center fade-in max-w-md w-full">
            <div class="text-2xl md:text-3xl font-bold text-primary-600 mb-2">{caseStudy.data.client}</div>
            <div class="text-muted-foreground">Client</div>
          </div>
        </div>
      </div>
    </section>

    <!-- Technologies & Partners Section -->
    <section class="py-12 md:py-16 px-4">
      <div class="max-w-6xl mx-auto">
        <h2 class="text-2xl md:text-3xl font-bold text-center mb-8 md:mb-12">Technologies & Partners</h2>
        
        <!-- Technology Logos -->
        {caseStudy.data.logos?.technologies && caseStudy.data.logos.technologies.length > 0 ? (
          <div class="mb-12 md:mb-16">
            <h3 class="text-lg md:text-xl font-semibold text-center mb-6 md:mb-8 text-gray-700">Technologies Used</h3>
            <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4 md:gap-6">
              {caseStudy.data.logos.technologies.map((tech: any) => (
                <div class="bg-white p-3 md:p-4 rounded-lg shadow-md hover:shadow-lg transition-shadow duration-300 text-center">
                  <img 
                    src={tech.src} 
                    alt={tech.alt || tech.name} 
                    class="h-8 md:h-12 w-auto mx-auto mb-2 tech-logo"
                  />
                  <div class="text-xs md:text-sm font-medium text-gray-700">{tech.name}</div>
                </div>
              ))}
            </div>
          </div>
        ) : (
          <div class="mb-12 md:mb-16">
            <h3 class="text-lg md:text-xl font-semibold text-center mb-6 md:mb-8 text-gray-700">Technologies Used</h3>
            <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4 md:gap-6">
              {caseStudy.data.techStack.map((tech: string) => (
                <div class="bg-white p-3 md:p-4 rounded-lg shadow-md hover:shadow-lg transition-shadow duration-300 text-center">
                  <img 
                    src={`/logos/tech/${tech.toLowerCase().replace(/[^a-z0-9]/g, '-')}.svg`} 
                    alt={tech} 
                    class="h-8 md:h-12 w-auto mx-auto mb-2 tech-logo"
                  />
                  <div class="text-xs md:text-sm font-medium text-gray-700">{tech}</div>
                </div>
              ))}
            </div>
          </div>
        )}

        <!-- Client/Company Logo -->
        {caseStudy.data.client && (
          <div class="text-center">
            <h3 class="text-lg md:text-xl font-semibold mb-6 md:mb-8 text-gray-700">Client</h3>
            <div class="bg-white p-6 md:p-8 rounded-lg shadow-md hover:shadow-lg transition-shadow duration-300 inline-block">
              <img 
                src={caseStudy.data.logos?.client?.src || `/logos/clients/${caseStudy.data.client.toLowerCase().replace(/[^a-z0-9]/g, '-')}.png`} 
                alt={caseStudy.data.logos?.client?.alt || caseStudy.data.client} 
                class="h-12 md:h-16 w-auto mx-auto mb-2 client-logo"
              />
              <div class="text-base md:text-lg font-semibold text-gray-700">{caseStudy.data.client}</div>
            </div>
          </div>
        )}
      </div>
    </section>

    <!-- Project Screenshots Section - Only for layaway-solution -->
    {caseStudy.id === 'layaway-solution' && (
      <section class="py-12 md:py-16 px-4 bg-white">
        <div class="max-w-6xl mx-auto">
          <h2 class="text-2xl md:text-3xl font-bold text-center mb-8 md:mb-12">Project Screenshots</h2>
          <ProjectCarousel client:load slides={layawaySlides} className="my-4 md:my-8" />
        </div>
      </section>
    )}

    <!-- Content Section -->
    <section class="py-12 md:py-20 px-4 bg-white">
      <div class="max-w-5xl mx-auto">
        <div class="bg-white rounded-2xl shadow-xl border border-gray-100 overflow-hidden">
          <!-- Content Header -->
          <div class="bg-gradient-to-r from-primary-50 to-primary-100 px-4 md:px-8 py-4 md:py-6 border-b border-gray-200">
            <h2 class="text-xl md:text-2xl font-bold text-gray-900 mb-2">Project Details</h2>
            <p class="text-sm md:text-base text-muted-foreground">Comprehensive overview and implementation details</p>
          </div>
          
          <!-- Content Body -->
          <div class="p-4 md:p-8 lg:p-12">
            <div class="prose prose-lg prose-gray max-w-none 
                        prose-headings:text-gray-900 prose-headings:font-bold prose-headings:tracking-tight
                        prose-h2:text-3xl prose-h2:mb-6 prose-h2:mt-12 prose-h2:first:mt-0
                        prose-h3:text-xl prose-h3:mb-4 prose-h3:mt-8 prose-h3:text-primary-700
                        prose-h4:text-lg prose-h4:mb-3 prose-h4:mt-6 prose-h4:text-gray-800
                        prose-p:text-gray-700 prose-p:leading-relaxed prose-p:mb-6
                        prose-ul:my-6 prose-li:my-2 prose-li:text-gray-700
                        prose-strong:text-gray-900 prose-strong:font-semibold
                        prose-code:bg-primary-50 prose-code:text-primary-700 prose-code:px-2 prose-code:py-1 prose-code:rounded
                        prose-blockquote:border-l-4 prose-blockquote:border-primary-300 prose-blockquote:bg-primary-50 prose-blockquote:p-4 prose-blockquote:rounded-r-lg
                        prose-a:text-primary-600 prose-a:font-medium hover:prose-a:text-primary-700">
              {rendered && <rendered.Content />}
            </div>
          </div>
        </div>
        
        <!-- Key Metrics Section -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-6 mt-8 md:mt-12">
          <div class="bg-gradient-to-br from-primary-500 to-primary-600 rounded-xl p-4 md:p-6 text-foreground">
            <div class="text-2xl md:text-3xl font-bold mb-2">{caseStudy.data.timeframe}</div>
            <div class="text-sm md:text-base text-primary-100">Project Timeline</div>
          </div>
          <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-xl p-4 md:p-6 text-foreground">
            <div class="text-2xl md:text-3xl font-bold mb-2">{caseStudy.data.techStack.length}</div>
            <div class="text-sm md:text-base text-green-100">Technologies Used</div>
          </div>
          <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl p-4 md:p-6 text-foreground">
            <div class="text-2xl md:text-3xl font-bold mb-2">100%</div>
            <div class="text-sm md:text-base text-blue-100">Project Success</div>
          </div>
        </div>
      </div>
    </section>

    <!-- Results & Impact Section -->
    <section class="py-12 md:py-20 px-4 bg-gradient-to-br from-gray-50 to-primary-50/30">
      <div class="max-w-6xl mx-auto text-center">
        <div class="mb-12 md:mb-16">
          <h2 class="text-3xl md:text-4xl font-bold text-gray-900 mb-4 md:mb-6">Project Impact</h2>
          <p class="text-lg md:text-xl text-muted-foreground max-w-2xl mx-auto">
            Measuring success through tangible results and client satisfaction
          </p>
        </div>
        
        <!-- Success Highlights -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 md:gap-8 mb-12 md:mb-16">
          <div class="bg-white rounded-xl md:rounded-2xl p-4 md:p-8 shadow-lg hover:shadow-xl transition-shadow">
            <div class="w-12 h-12 md:w-16 md:h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-3 md:mb-4">
              <svg class="w-6 h-6 md:w-8 md:h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
              </svg>
            </div>
            <h3 class="text-sm md:text-lg font-semibold text-gray-900 mb-1 md:mb-2">On Time</h3>
            <p class="text-xs md:text-base text-muted-foreground">Delivered within {caseStudy.data.timeframe}</p>
          </div>
          
          <div class="bg-white rounded-xl md:rounded-2xl p-4 md:p-8 shadow-lg hover:shadow-xl transition-shadow">
            <div class="w-12 h-12 md:w-16 md:h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-3 md:mb-4">
              <svg class="w-6 h-6 md:w-8 md:h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
              </svg>
            </div>
            <h3 class="text-sm md:text-lg font-semibold text-gray-900 mb-1 md:mb-2">High Performance</h3>
            <p class="text-xs md:text-base text-muted-foreground">Optimized & scalable solution</p>
          </div>
          
          <div class="bg-white rounded-xl md:rounded-2xl p-4 md:p-8 shadow-lg hover:shadow-xl transition-shadow">
            <div class="w-12 h-12 md:w-16 md:h-16 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-3 md:mb-4">
              <svg class="w-6 h-6 md:w-8 md:h-8 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
            </div>
            <h3 class="text-sm md:text-lg font-semibold text-gray-900 mb-1 md:mb-2">Client Satisfaction</h3>
            <p class="text-xs md:text-base text-muted-foreground">Exceeded expectations</p>
          </div>
          
          <div class="bg-white rounded-xl md:rounded-2xl p-4 md:p-8 shadow-lg hover:shadow-xl transition-shadow">
            <div class="w-12 h-12 md:w-16 md:h-16 bg-orange-100 rounded-full flex items-center justify-center mx-auto mb-3 md:mb-4">
              <svg class="w-6 h-6 md:w-8 md:h-8 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4h13M3 8h9m-9 4h6m4 0l4-4m0 0l4 4m-4-4v12"></path>
              </svg>
            </div>
            <h3 class="text-sm md:text-lg font-semibold text-gray-900 mb-1 md:mb-2">Future Ready</h3>
            <p class="text-xs md:text-base text-muted-foreground">Scalable architecture</p>
          </div>
        </div>
        
        <!-- Technologies Showcase -->
        <div class="bg-white rounded-xl md:rounded-2xl p-4 md:p-8 shadow-lg">
          <h3 class="text-xl md:text-2xl font-bold text-gray-900 mb-6 md:mb-8">Technology Stack</h3>
          <div class="flex flex-wrap justify-center items-center gap-3 md:gap-6">
            {caseStudy.data.techStack.map((tech: string) => (
              <div class="bg-gray-50 px-3 md:px-4 py-1 md:py-2 rounded-lg border border-gray-200 hover:border-primary-300 transition-colors">
                <span class="text-sm md:text-base text-gray-700 font-medium">{tech}</span>
              </div>
            ))}
          </div>
        </div>
      </div>
    </section>

    <CTABottom />
  </div>
</Layout>

<style>
  .fade-in {
    animation: fadeIn 0.8s ease-in-out;
  }

  .fade-in-left {
    animation: fadeInLeft 0.8s ease-in-out;
  }

  .fade-in-right {
    animation: fadeInRight 0.8s ease-in-out;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @keyframes fadeInLeft {
    from {
      opacity: 0;
      transform: translateX(-20px);
    }
    to {
      opacity: 1;
      transform: translateX(0);
    }
  }

  @keyframes fadeInRight {
    from {
      opacity: 0;
      transform: translateX(20px);
    }
    to {
      opacity: 1;
      transform: translateX(0);
    }
  }

  .tech-logo, .client-logo {
    transition: opacity 0.3s ease;
  }
</style>

<script>
  // Handle logo fallbacks
  document.addEventListener('DOMContentLoaded', function() {
    // Handle tech logos
    const techLogos = document.querySelectorAll('.tech-logo');
    techLogos.forEach(img => {
      img.addEventListener('error', function() {
        // Hide the image if it fails to load
        this.style.display = 'none';
      });
    });

    // Handle client logos with multiple format fallback
    const clientLogos = document.querySelectorAll('.client-logo');
    clientLogos.forEach(img => {
      img.addEventListener('error', function() {
        const baseSrc = this.src.replace(/\.(png|jpg|jpeg|svg|webp|avif)$/, '');
        const formats = ['webp', 'avif', 'svg', 'jpg', 'jpeg'];
        
        let formatIndex = 0;
        const tryNextFormat = () => {
          if (formatIndex < formats.length) {
            this.src = baseSrc + '.' + formats[formatIndex];
            formatIndex++;
          } else {
            // All formats failed, hide the image
            this.style.display = 'none';
          }
        };
        
        this.onerror = tryNextFormat;
        tryNextFormat();
      });
    });
  });
</script>
